import re
from copy import deepcopy
from math import prod

from aocd import submit

N = 103  # tall
M = 101  # wide


def parse(lines):
    pattern = re.compile(r"p=(\d+),(\d+) v=(-?\d+),(-?\d+)")
    pvs = list()
    for line in lines:
        m = re.match(pattern, line)
        if not m:
            raise ValueError("panic")
        pv = ((int(m.group(1)), int(m.group(2))),
              (int(m.group(3)), int(m.group(4))))
        pvs.append(pv)
    return pvs


def part_a(input):
    state = deepcopy(input)
    for _ in range(100):
        state = next_state(state)
    return prod(robots_by_quadrant(state))


def robots_by_quadrant(state):
    q = list()
    a = (N-1) // 2
    b = (M-1) // 2
    for i in range(0, N, a+1):
        for j in range(0, M, b+1):
            c = 0
            for k in range(0, a):
                for l in range(0, b):
                    for p, _ in state:
                        if p == (j+l, i+k):
                            c += 1
            q.append(c)
    return q


"""
6771
...............1.....................................................................................
.........1...........1...............................................................................
...............................................................1.....................................
..........................1...........1.1............................................................
.......1.......1.........................................................1...........................
.............................1....................1..................................................
..1..................................................................................................
..1..................................................................................................
...........................................................1..........1..............................
.........1...........................................................................................
...........1......1..................................................................................
......................1...........................................1..................................
.................................................................1.....1...........................1.
................................................................1....................................
1..........................................................1.......................................1.
................1....................................................................................
.........1...........................................................1...............................
..............................1......................................................................
.1...........................1....................1..................................................
.....................................................................................................
................1....................................................................................
.......................................................1.............................................
.....................................................................................................
.......1............1..................................................................1.............
.....................................................................................................
..................................................................................................1..
.....................................................................................................
.........................................................1................................1.....1....
.....................................................................................................
........................................1.............................................1..............
................................................................1...............1....................
..............................................................................1......................
...1..........1............................1...............1.......1.................................
....................................................................................................1
.............................................................................1.......................
.....................................................................................................
...............................................................................1.....................
.....................................................................................................
............................1.......................1........1..........1............................
.....................................1...............................................................
.....................................................................................................
..............1......................................................................................
..........................1..........................................................................
....................................................1.........................1..................1...
................1....................................................................................
..............1.................1...................................................1................
.........................................1...........1...............................................
.............1.........................1...............................1............1................
........................................................................1............................
..................1..................................................................................
.......................1....1.........................................................1..............
.1................................................................................1.................1
............................1111111111111111111111111111111..........1...............................
............................1.............................1.......................1...........1......
............1...............1.............................1..........................................
............11..............1.............................1.......................1..................
............................1.............................1..........................................
............................1..............1..............1........................1...............1.
............................1.............111.............1..........................................
............................1............11111............1..........................................
.......1....................1...........1111111...........1..........................................
............................1..........111111111..........1..........................................
..............1.............1............11111............1..........................................
...............1............1...........1111111...........1..............1...........................
............................1..........111111111..........1.................................1........
............................1.........11111111111.........1..........................................
......................1.....1........1111111111111........1..........................................
.........................1..1..........111111111..........1..........................................
............................1.........11111111111.........1..........................................
............................1........1111111111111........1..........................................
............................1.......111111111111111.......1..........................................
.........1..................1......11111111111111111......1..........................................
.......1..........1.........1........1111111111111........1.....................................1....
........1...................1.......111111111111111.......1..........................................
............................1......11111111111111111......1...1......................................
...............1............1.....1111111111111111111.....1.....................1....................
............1...............1....111111111111111111111....1.1........................................
............................1.............111.............1.........................1................
.................1.......1..1.............111.............1.........1................................
............................1.............111.............1..........................................
.....................1......1.............................1..........................................
...................1........1.............................1..........................................
..............1.............1.............................1..........................................
............................1.............................1..........................................
............................1111111111111111111111111111111......1...................................
.................1.................................................1......1..........................
......1....................................1.........................................................
.................................................11..................................................
.....................................................................................................
...............1.....................................................................................
.................11.......1..........................................................................
.........1..........1.................................1..................1...........................
..................1.................................................1................................
....................................................1.......................1........................
...........................................................................1..............1..........
...............1.....................................................................................
.....................................................................................................
...........................................1.........................................................
.....................................................................................................
....1................................................................................................
.................1...............................................................................1...
.............1.......................................................................................
.................................................1...................................................
"""


def part_b(input):
    state = deepcopy(input)
    for i in range(10_000):
        state = next_state(state)

        if (i % M) == 3 and (i % N) == 75:
            print_map(state)
            return i+1


def next_state(state):
    next_state = list()
    for (px, py), (vx, vy) in state:
        nx = (px + vx) % M
        ny = (py + vy) % N
        next_state.append(((nx, ny), (vx, vy)))
    return next_state


def print_map(state):
    for i in range(N):
        for j in range(M):
            c = 0
            for p, _ in state:
                if p == (j, i):
                    c += 1
            if c == 0:
                print(".", end="")
            else:
                print(f"{c}", end="")
        print()
    print()


if __name__ == "__main__":
    with open("input.txt", "r") as f:
        lines = [line.rstrip() for line in f]

    input = parse(lines)

    a = part_a(input)
    if a:
        print(a)
        submit(a, part="a")

    b = part_b(input)
    if b:
        print(b)
        submit(b,  part="b")
